using System.Collections.Immutable;
using MemoCache = System.Collections.Generic.Dictionary<(string, System.Collections.Immutable.ImmutableStack<int>), long>;

namespace AOC2023
{
    internal class Day12
    {
        // Immutable collections used for DTOs - remember that's important
        // Memoized recursion is a thing

        private const string input = @"..?????#??.?##? 1,1,2,3
###?.#???.?#.# 4,2,2,1
?????##???#? 7,1
??????#.?#####?? 1,1,1,6
????#?#.??#?# 3,3,3
?????#?#.? 2,2,1
..???.??#??? 3,3,1
????.??????##??#?#? 2,2,9
??.#??##??.#?? 2,5,1,1
.???????????#? 5,1,1
???.????#??? 2,6,1
?#???.??#?##??#?.# 2,8,1
?????.???? 2,2
????#?#??.?#?.? 1,1,5,1,1
..?#??#???#?????. 5,6
??.#..??#??????#???? 2,1,10
????.????#.??.#??? 1,1,5,1,1,1
?????????#?##?.. 1,6
.??.??.??#????? 1,4
?????.??#????#? 1,8
?.???????##????#?.?? 14,2
?#.????#.????.? 1,2,1,1,1
?#??.???????? 1,1,7
.????.??????.# 3,3,1,1
???#??#?.?...? 5,1,1
.???#???.##??? 2,2
???#???..?#?? 6,1
#??.???.#? 3,1,1
??#???.###???#?.?? 4,3,2,1
?.?.?????????. 1,1,1,2
.?.??..???????? 2,5
?#?#???????.?.?.? 5,4,1,1,1
??#?#????##??.???? 5,6,2
???.#?###????.? 1,6,1,1
.???.??.#?#??? 2,4
##?#?????#?.#?# 5,2,3
.##????#?#??#?#??. 3,9,1
???????#???.??#??? 7,4
?????..?#??#?#??###? 1,1,1,5,1,5
.????.??????.##???. 3,2,1,5
????.#????#?.# 3,7,1
.???????.?# 5,1
.???.?#??.???##??#?? 1,1,1,10
??#??????? 1,3
##.???.????#? 2,1,1,4
.?#..??.????? 1,2,3
??????????#?.?? 5,4
?#?????????.?## 7,1,2
??#?#?#????????.?#?. 14,2
????.??????..??# 2,1,2,3
???.?#?#????????..?. 1,1,8,3,1
.??.?#?.?#? 3,2
??????????.?? 1,2,1,1
?????????. 3,1,1
#?.?#?#?.###??#??. 2,2,1,7
??.??#???? 1,4,2
???#?????????#?? 4,1,1,3,1
??..?#?.??.??.#??#?? 2,1,5
??..???#??.?? 1,4,1
.??#?.???.????#??. 3,2,7
#.??????????#?? 1,3,1,2,3
?..????????# 1,1,1,1
????????#? 1,1,2
????##??#????#..# 12,1,1
?#?##???.??## 1,2,1,4
.###???..??.? 6,1
.?#??#?#??.?????.#. 8,3,1
?#????#???????.. 7,1,3
??.##???.?. 1,5
?.??##???.?? 7,1
#????.#????? 3,1,1,1
#????????????.??. 7,2,2
?#???..?#??#?? 4,2,2
??##??.?.#?#. 6,1,1,1
#.?.???.???#??#???. 1,1,2,1,7
????#?????????. 1,4,1,2
??#??????????.????. 5,3,3
??.??#####?#???.?? 2,11,1
??#.????.?. 3,1,1
.???.##????.. 2,6
?????#?????#??. 2,3,5
??????.?.?#???#. 2,2,1,2,3
??????#??? 1,1,1
???????????###?#?? 7,9
????#?##??????? 2,8
??#??#.#???????#?? 3,1,7,1,1
????????#??##.? 1,1,6,1
.????????.? 3,1
##.??#?????# 2,1,3,1
???????????#?????? 1,1,10,1
?????.#??..?????? 2,2,6
?.###?.???????? 1,4,1,1,2
.?##?????????. 6,3
?#??.#??#????#??#? 1,1,1,10
.????#???? 3,2
???.#?#???? 2,7
??#???#?#?#?.?.? 1,5,1,1
#????.?#??????#?#? 1,2,1,9
??###????##?#? 5,5
??##??#??????????? 5,8
.????.??????? 3,1,2
??##???????.##?#? 4,3,4
#?#?????###??##????. 1,2,13
??#.????#??. 1,1,1,1
.?#?##?.?#..?? 6,1,1
#?##??.?.???????#??. 4,1,9
???#?#?.???#??? 2,2,1,2
..#????.????#. 2,1,1
.???.???#?????.? 2,1,3,1,1
?#????.???.???## 2,1,2,4
#?#?#???#?##??#?. 1,3,3,2,1
??#??#???..? 1,1,2,1
???..##.#?????.. 2,4
#???#?.?#?#?#????? 5,1,1,1,1,1
???.??.???? 1,2,2
????##?.#???.??????? 5,2,1,2,1
.#???.?.??????#?#?.? 2,1,2,3,2
??.????????? 1,1,1,1
???##???????#??????. 9,2,3
?#?#??#????..?#.. 9,1
??#.???????#?#???# 1,4,1,1,2,1
?#?.??###?##????.?? 2,8
???#????#?#?.? 2,3
.??##???..?? 3,1,1
##.#?#.??#?????. 2,1,1,6,1
?##???.#??? 4,3
.?##?#?????##???. 3,1,6
.????#??#???.?# 1,7,1,1
?????????#.?.?#?. 2,1,2,2
??..?.##?#??##? 1,8
??????#??? 2,3
???#???.#??.#??# 5,1,1,1
?#?#???.?#.?????#?# 3,1,1,1,1,3
?????????? 1,3
?#??##??????????.?? 9,4,1
??#????????.? 3,1,1,1
??#.?#??#?#.??.?#.? 3,5,1,2,1,1
??##??????.?#?#????? 3,6
???.?#?#???.??. 1,1,3,1,2
????.???.??????#?#?? 4,1,1,8
????##?.????#??.?? 1,4,5,1,1
???#???#?#?..??. 10,1
###???##?#?#####?# 4,12
.?.??.???# 1,1,3
??#?#?.??.? 5,1,1
?#??###???#???.????? 13,5
.????#?#????#??# 5,4,1
.???#???.??#??#.?. 6,5
.?????..?????????# 4,7,1
????????????# 1,3,3
???..?##??###????? 3,2,4,2
???#???????#?? 1,1,1,3
?????.?.#####... 1,1,1,5
????.?##????# 4,3,1,1
?#???#?#????#???. 1,11,1
.??.????#?? 1,5
???#.?.#?#??#?##?# 1,1,1,6,2,1
?.?.#??#???? 1,1,7
??????##?#?## 1,7,2
????????#?..??? 1,1,3,1
.?.????????.?.? 4,1,1,1,1
#?.???.??##?.?# 1,3,3,1
#?.???????? 2,3,1
???.??.??#???## 1,2,3,3
????????????#. 3,3,1,1
.#??..##??.??#?????? 1,1,4,1,3,1
??#.??.?#???#?? 1,1,7
???#?#??.?????#?? 7,1,1,2
...?????#? 1,2
.?#???#.#???? 5,2
?#???#???.?#???.? 7,1,1,2
????#?????#? 1,3,2,2
?..#???.?##. 2,1,2
?.?#.??#?? 1,1,1
?.##??##?##????#?? 1,12,1
?????#?#..? 1,6,1
?##?????.??? 3,2,2
.?.???????. 4,1
????#???###???? 1,3,4,2
???.#???.??? 2,1,1,2
??????##.#.???? 2,2,1,2
??.????#.??#???????? 1,1,1,7,1
.??#?#?##.?#? 1,1,2,2
.?#.???#?#??. 1,6
..??##?#????.##?. 10,2
..??#??.?.??.???? 3,1,1,2,1
..????#?...?.?#??.. 1,3
..??##..?.#????. 4,1,2,1
?.????##??? 1,6
?.???????#?? 3,2
????.??????? 1,1,3
???????.?#?##?.??#?. 4,5,4
?.?#?...?##??. 1,2,3
?#?#.??#??? 4,2,2
???##..??????? 3,1,1
?###??????? 7,1
?.#????###?????? 1,1,5,1,1
##?????????????.# 5,1,2,1,1
.???????.?????.#??#? 2,2,1,5,5
.?#??#????.???? 2,5,1
????.??#?#????? 1,9
.?#???.???? 3,4
?#???#??.???? 6,1
#????????##.??. 1,2,2,3,1
????????#???## 1,3,4,2
??###?????#??????.. 3,6,2
???????#?.#??##? 5,1,3
??.??..?.??#.? 1,1,1
??##??????.??#???? 1,2,4,1,5
?????#?.#??###?.??? 1,1,2,1,4,3
??#??.#??????#. 3,5,2
??.??????. 1,1,4
??.????#?????.. 1,9
?..??..??? 1,1,2
?.?.?????##?#??#???? 1,12
????????.? 1,2
??#??.?#?##.? 1,1,1,2
.???###?????? 6,1
.???????????# 2,2,5
.??????#?#??.?#? 1,1,4,2
???#??.??. 1,3,1
.#??#?????..#???# 8,5
??#?.?.??#??. 1,2,1,2
??.????##???? 1,1,4,1
.???#.?.???????? 2,1,5,1
???????????????#??#? 3,11,2
???##????????.??? 10,2
?##??#???#??????? 10,3,1
.?###????#???.??. 11,1
???????.?#?????#???? 6,9
?#??#??.???????# 7,1,1,1,1
?##??.#?????????? 4,1,5,1
.????..#??##??#??..? 3,10
??????????#???#? 2,8,1
???.??.?#?? 2,1,4
?#???#??#???#?# 2,4,2,1
?.#??.#..??#. 3,1,2
??.???#???.???.?.?? 1,1,4,1,1,2
????????????.??#. 6,1
?#??#?#??#??#?????? 2,3,1,8
?.?????????#??? 6,2,1
????.?#?#??#??? 1,8
.?.???.???#. 1,1,4
.?#?..????? 2,3
.??#???????? 5,1
???????????. 1,1,1,1
.##?....#? 3,1
???.#?#????? 2,3,2
#??#..??.?.???? 4,1,1,1
??##.#??.#?. 2,2,1
?????????? 2,1,2
.?.###???##?#???? 1,3,8
?.?????.#???## 1,1,1,3
?.???#??#?##??????? 11,2
.#??.???.???? 3,1,1
??.?##??.?????.???? 1,4,4,1,2
???#????.?#? 1,3,1,3
.???#????##?????. 8,2
????#.?.???? 2,2,1,1
??##??..???????##.?. 5,9
.??????#?? 2,2
???#??#??#??#.. 1,8,1
???#????.#.???. 1,4,1,1
???.????.??#???#?#?? 2,1,9
?????????..?? 1,1,1,2
????#.#???..? 4,1,1,1
#?.??#?##??#???.?#. 2,9,1,1
?##??.#??.? 2,2
?#?.??##?? 2,4
?#??.?##?????????? 3,8,1,1
?#??...????? 4,2
?#?...?????###??#..? 1,8
???.#????? 1,3
#????.?.?????##??? 1,1,4,4
??##?.????..# 3,1,1,1
???#????#?#. 2,8
?#?#??????? 5,3
??#???.??????#?#? 3,1,1,4
????#??#????.?? 1,8,1
?#????.?????#??? 4,1,2
???.?#??#??#????#? 2,13
??.???#???#??. 1,1,1,3
.???#?#?.?. 3,1
.??#???????.#?. 9,1
?.??#?#??.?? 2,1,1
?.?#??..?#?..?# 1,3,1,1
.?.#?#?.??????????? 3,2
?#??.??##??? 3,5
???#?????. 1,4
???#?#??????##????.? 9,2,2
.?????#?????# 7,3
??#####??? 6,1
??#??..###???? 5,6
.???#??.?#?????. 5,2,2
????#?.???###?#?? 2,1,9
??????#.?#?# 4,2,1,1
.?????.#????#?? 1,1,3,3
??#???#.?.??.? 6,1
?????#?????##??? 5,7
#???.??.???.?????? 3,1,1,1,1,2
??.?????##????#..? 7,3
.???.????###.#? 1,2,4,2
?.?.#???.????????.?# 1,1,2,2,2,1
##?.????.????#????. 2,3,7
#?#?####????.??..?? 1,9,1,2
?#??#...#?.. 4,2
.???.?#???#.???.??? 2,2,1,1,1,2
???????.???????##?. 1,4,1,2,5
??..??#?#????#?? 1,1,10
??#?..?#?#??##?. 2,8
##?###??????.#??# 12,1,1
?#???.?.???? 2,1,1,1
?#??.#???#???. 4,1,4,1
?#?##??????? 2,2,2,2
???#?#?##??.#??? 1,7,1,1
???#???#??#? 2,7
?###.#?#?? 4,4
??.???#????.#? 2,6,1
????#.?#????#?#?#?#? 2,1,1,10
?#?..???????#?.? 2,9
?.#?#?...#???##??.?? 4,1,3
.?????.?.???#?#.? 3,3
.??#??##??? 2,4
.?.??.??.?#? 1,1,1,1
#.????#?#. 1,1,4
.?.?????#?????.? 6,2
.????.???????.#?##?# 1,1,1,5,4,1
.?#??..#...?##?? 3,1,4
####?.??????.???.?? 5,4,1,3,1
?#.?#?##?#????????? 1,11,1,2
#??????#??#????.# 12,1,1
.?##???##???#?#?? 4,3,4
?..??.?.???? 1,1,1,1
?????.?????????? 1,1,2,1,4
?.#??????.??##?## 1,1,1,1,7
?.??.?????#???? 1,1,1,2,2
??????????? 5,3
????.???#??? 1,6
.?##????????.# 8,1
?#???...?#??? 2,2
?????.#?????. 2,1,3
??????#??? 5,1,1
#?#?????????? 10,1
??????????#?? 1,1,2,1
???#???#??????????? 14,1,1
.?..?#??...#??. 1,1
???.#?#?#? 1,1,3
???????#?#??.?#??? 3,2,2,2
..???..#??#. 3,4
????#?#??#.??..?###? 1,1,1,4,1,5
?#??.????#???#. 1,9
?.??.?#??.??#????.?. 2,3
.????.???#?.? 1,4
.???#?#?##???#???#? 9,2,2
?#????##.? 2,4
?.?#??##????.??##? 1,7,1,5
????????????##??#?? 6,6
?.??#?##?.? 1,1,4
??##??#???##??? 11,1
??#???????# 2,6
??#?#???..?.???# 7,1,1
.??????#??#?????? 1,1,8,1
????#???.?#?#???? 2,1,2,7
????#???###.??? 1,1,4,1
????#??.??? 1,1,1
?.??###??#????.? 6,1
??#????###?#?? 3,7
???.??#?.??#?#???.. 2,3,7
?????.?.????.. 1,3
???##?.?.??? 1,3,1,2
???.#????.??? 1,1,5,1
????.????## 2,6
#?.?#?????..?##..? 1,6,3
?.????#?????#?? 3,3
?#.??#?#?#????.#? 2,9,1
??????.??. 2,1,2
?.????#??.?? 1,1,3
.?.##???????? 4,3
??#???????###?##??? 1,1,1,1,7
??#????.??#.?#?? 3,3,1
#?..???#????? 2,1,7
?.?#??#????? 1,1,1,1
..??#?????#???? 6,4
.##???#???????. 8,1
???????..?#??? 1,2
????????????????? 2,1,9,1
?..????????#???#?#. 1,1,11
?#?.?????#??????#?? 1,5,5
??#?#??#?#??? 1,3,1,3
?#.?##??????..#?.#?? 1,9,1,1
??.?.?#?.??? 1,1,3,3
?#?##?????#? 1,2,6
?#?#??#?#?..#. 4,5,1
??#????.?? 2,1,2
???#.??????##???..?? 4,7,1
#??????????????? 1,6,5
?#?#????.#?#??.??? 4,1,3,1,1
.?##??.???? 3,2
????#?????##.#????? 4,2,4,1
?.?.??#?#??? 1,8
?????#?#?#????? 2,10
???????##????.#? 1,1,1,6,1
.#?#?.???????#??#??? 3,10,2
??.#..#..??? 1,1,1,1
.??#??##??.?????#? 6,1,1
..???????????#. 1,6,2
???????#??. 1,5
???????##????????? 1,1,5,2,1,1
??#??.????? 3,2
???##?#????? 1,8
??.?.??#..?##?????.? 3,7,1
??????####??#.?.##?# 1,1,4,1,2,1
????#???#?????????.? 7,7
??#?????#??? 2,1,2,1
.??.??.?.?.?...?? 2,1
???#?#?????.?.?? 9,1,1
#?....?.????.?.?.?. 1,1,4,1,1
..??#?#???.. 1,3
#????#.#???.?? 1,3,3,2
???#???#??? 4,3,1
.???#?#?#??.#???#? 2,1,1,1,2,2
?#?..#?#????##?? 3,3,1,5
?..???#?#? 1,5
???#??#?????#???.. 1,2,1,1,1,4
????.????#??. 2,2
???????#?.??? 5,2
#?#?????###?#?#??? 1,3,1,8
.#????###??? 3,3
#.??##??#??#?.?? 1,1,9,1
..??#???#?.??? 7,1
??#???????.# 3,4,1
?????#?#???.?????.?? 4,1,2
?#?.?...#?#??#??? 2,1,1,7
??..??#..??.???.? 1,2
???#?##??#?? 1,7
??#?#??###?????.#?? 1,1,7,1,3
.?#???#..?#?#??? 1,1,1,3,1
??????#?##??## 1,4,2
???#??#.?? 2,1
.??????##?? 1,1,3
#?.???###??#????#?? 1,14
???#?.?????.??. 1,1,1,1,2
?#???###.?##????. 4,3,4,1
????.?##???##.?#???# 1,1,8,2,2
?.###??????#?????? 3,6
?###?????#?#.?? 4,5,1,1
?######?#??# 6,4
???#??????#.? 2,1,2,1
??.??????. 2,1,1
??###???.??#.# 7,3,1
#..?????.# 1,4,1
?.#?????.?..? 6,1
???????.???#?? 1,1,2,1
?.?..????.? 1,1
?#????..??.?#? 1,3,1,3
.??#.??.?...# 2,1,1,1
.????.??##? 3,4
????.???#??. 1,1,4
#??#???#?????????? 12,2,1
.??#???????????? 1,3,1,2,3
.???....#??.? 2,2
???#???#..? 1,1,1
????....#??##?????? 4,9
?.???#??#? 1,2,4
???.?.?.#?????.?. 1,6
??..#??##.#.????. 1,5,1,1
??#??????? 2,1
????#??..#.#. 1,2,1,1
?.#????##??#?.? 1,1,7
.??##???#??.. 1,4,1,1
??#??????#?..??#???? 8,2,1,1,1,1
???.??.?##?.?..? 3,1,4,1,1
#??##??.##????? 2,3,5
?????##?#?.???#??. 8,3
???#??????#?#??#???# 6,12
??#?.?????? 3,5
?.?#??????#? 1,7,1
.??##?????????#? 3,9
.??#???????.?#.?.. 7,2
??????#?????#??# 1,2,1,1,1
?#???#??#?.##??.. 6,1,3
.???#?..?.???.. 3,1,2
.###?###?????.? 7,1
.?#?#?#?#????..? 2,9
.?????.???????? 1,7
?##???..?#??#??##?#? 5,12
.#???.?#?#..?#?????. 4,1,1,7
?.#????..?.?????#?.? 1,6
..#?##?????#? 1,2,1,3
???.????????#.?. 3,1,3,2,1
???#.##??#?.?# 1,6,1
?#.?#?.??#?#? 1,3,3
.?##??.???##????? 3,1,4,2
.??????#?? 1,1,1
#???#..?.## 5,2
????.?###?? 2,4
??.?.#????? 1,6
????#???????#.?#?.? 1,1,3,1,2,1
???##??##???..?? 9,1,1
?#.???##?. 1,1,2
?.??#?#?.?.?####.?? 1,1,1,1,5,1
?????#???###????? 2,2,3,1
?##????.?#??.#???? 7,1,1,1,2
???.??#??? 1,3
..#???#???.?#?.#???? 1,1,4,2,4
?##.?##.?. 3,3
????#???.?#?##????. 4,1,7,1
?????#..??? 4,1,2
??#????#.?????????? 3,4,5,1
???????.?? 1,1
????#???#.#??? 1,6,1,2
??#?.???#?#?.??#? 3,7,1,1
???.#?????### 1,9
##...??#??? 2,1,4
.?.?????????..??? 3,1,2,1
?#??#?#???? 7,1
????#??.??? 4,1
.?????.#????#??# 1,1,1,1,4
?..??.???????#?#???. 1,1,1,1,5,1
?.???.????. 1,1,3
??????????? 1,1,2
.#.??#.??..??? 1,2,1,1
.#???#?????. 6,1
????.?..?# 1,1,1
.??##?.??????? 2,1,2,1
?.???????? 2,1,2
??#?#????##???#?? 11,1
?#.?????#? 2,1,2
.#???#????.?.?##? 6,1,1,4
??#?#?#????#. 7,1
#???.#??.#??????#?.? 4,2,9,1
??????.??#?. 4,1
?#??.???????. 1,4,1
????.??.??.?# 2,2,2,2
????#??.?#? 7,2
..?#???.?????.????? 5,1,1,2,1
.??#????.#?#?..? 4,4
??#????#?.???. 2,4,1
??????????.? 1,2,4,1
?..#..#?#..??## 1,3,4
#??????#?#?.#??????? 1,1,5,1,6
?#.?.#???. 1,2
?#?##.?#.#?.???#? 4,1,1,1,3
?..?.?.#?.?? 1,2,2
???#?????? 2,4
?.#????#???#???##. 1,13
..???#?#??##?..#?##? 6,2,5
.#?.??#.???# 2,1,1,1
??#??.?????. 3,1,1,3
??#?#.?#??#.?#?#. 1,3,1,1,3
.?..?.??????.? 1,1,5,1
.?????##??? 1,1,3
??#...?.??#?#???#? 1,1,1,3,1,1
?#??.?#?##??.? 1,1,5,1
?..#???#?????. 1,2,3
?#??##????#?#??? 6,4
?#?????#?.?? 1,5,1
?.#???##???...? 2,5
??.???????? 1,5
??????.??#.? 3,1
?.#???#?#????#??#?? 1,1,4,6
?.#?##????#?? 4,3
??##??#??????#? 11,2
??#????#????? 3,6
.????#..?? 3,2
?..??#????#? 1,1,4
.??#?#?????? 7,1,1
?????.????????# 2,1,4,4
#??????##???? 1,1,5
?????.???##?##?#???. 4,9,1
?#?#???????? 8,1
???????#??#?#?## 1,1,10
?..?.?#.?#?#.???? 1,1,4,1,1
??.??..??. 1,1,1
.?.???.??#? 1,2,2
.?.?#????##?##. 1,5
?.??#####???#??#??.. 5,5
.??##.?.?#. 3,1
?##???.?#. 5,1
??##???.??#?#??#.?.. 6,7
???#.??.???# 3,3
?.?.???##?????? 1,6,1,1
#????#???# 1,2,1
??.?.?????#???# 1,1,1,1,1
?#???.???????.#? 4,1,1,2,2
.??##?..?##?????#.? 1,3,9
????#?????#? 2,1
?.?##??????? 1,6,1
.###??#?.?#??# 3,2,4
????###??? 1,3
??????#??????????? 1,7,3,2
??#.?##?#. 2,4
?..??????. 1,1,1
???.??#?#??#?????# 2,1,8,1,1
?.#???????.????. 7,1,1
.#.?#?###.##??????.? 1,1,3,2,4
??.???.??#??##?#?. 1,8
..?#??#?????#?.. 5,1,1,2
?.??????.??????? 1,4
????????#.??#?##.# 1,2,2,4,1
?.??.?.??##?.. 1,5
..?.??.#????#?? 1,2,1,4
??#?.?.###?.??#?? 2,3,3
????###????#???#? 6,1,1,1
??#?.?##????????? 3,7
???????.???? 1,2,1,2
??#????##?.???#??? 1,7,2,1,1
.?.?....???###?...?? 1,6
.?#???##????? 3,7
???????#??? 1,4
#?#.?#??#. 3,5
.?#?????.?.??# 1,2,1,2
????.#?#???#??#?? 1,11
?##????.##???? 7,3,1
#???#?????#?#?#??? 1,3,1,9
..?????#?.?????? 7,1
???#??#??##????#??? 1,1,2,8,1
????????.???? 6,2
.????#????????#?? 4,4
.?????##?? 2,4
.??.???.?????.#? 2,1,2,1,1
???.##.##..##? 1,2,2,2
??###.?????????????? 5,1,2,1,5
?????#?###??.. 2,1,3,1
?.????#?#??.?.?? 1,3,2
??#.??#??. 1,5
?#?..???#?## 3,1,5
?#..?#????? 1,1,2
.???#????#. 3,2
?????????###? 2,4
.?##??#????.? 8,1
.#???#.??#? 5,1,1
?#??.??..??????? 2,2,6
#?##???#???? 5,5
?.?.??#????#??#??. 1,1,7,1
.##??..#?.?? 2,2
????##.????.? 3,2,1,1
?..????#?#?#.???.??? 8,1
???#??.????..?.? 1,4,1
.??.??.#????####?? 1,1,9
??#?.??#?.??? 3,4,2
??#?????##. 3,4
??#?#..??#??? 1,1,2,1
???.??##??##???#? 1,10,2
.#??.?###?.#????#?. 3,4,3,2
?#?..???????.?#?? 1,5,2
????????#?????.? 4,4,3
????.#??.?.?? 4,3,1
..##.?????. 2,2
.???????#??? 2,4
?.????#.??###?# 1,1,1,3,1
#?#??????.#?#.?? 5,1,1,1,1
##???.#?????.???#?# 2,1,4,1,4,1
.##?#?..??## 2,2,4
?#?????.??#??#??#?. 1,1,1,8
#????????#????##? 1,2,7,3
#..#??.??? 1,2,3
???#??#?#?# 4,3,1
#?.?##???? 1,4,1
??????.??.. 3,1
???????#???..?? 2,1
?##????..??# 5,3
???#..??#? 1,1,3
???...???? 1,1,1
????..???.???.. 1,1,1,1,2
??.??##??# 1,7
??????.???#???? 2,1
?????????.#??.?? 6,3
??.????.?. 1,2,1
#####?????# 5,1,1
?????#.?##?#?#????#? 6,5,1,1,2
??#??##???? 3,6
?????.??.?.????#??. 1,2,2,1,7
??????#??.#?.??? 3,2,1,1,1
??#????#?#? 3,1,4
??????#.?????#????? 1,4,6,3
#???.?#??.#???? 4,2,1,1,1
?..?.##?.?.??.??#??? 2,6
?????????.???? 1,4,1,1
.?.??#?#??????????? 8,2,2
#.#?????..??????#? 1,1,1,1,1,3
??.??#??????? 2,3,2,1
??.?.???????? 1,2,1,1
.??.?##????? 1,3,1,1
?????.?????? 2,2,2,2
?????#.???#.?# 4,1,1,1
??????#??.?????? 1,6,5
#?.?.??#?##??#?#? 1,12
??#?##??#?.???? 5,2,2
#???#??..????#??? 7,1,3
????????#?#??#???.?? 12,1
??.?????..????? 1,2,1,3
?.??#?????#?#????# 1,15
.??????#?##?.??? 1,8,1,1
.???????#.?# 5,1,1
?#?##???#????#???#?? 8,3,3
????????#???#. 3,2,1,1
#???#.?#??? 1,2,5
??????.??##?. 1,1,1,2
?#.??#?#???? 1,4
#????#???? 2,3
?.#?#.?##?#????.?? 1,1,2,2,1,1
???????#?#.#??#.??# 1,8,1,1,1,1
?#.#???###?? 1,1,5
.??.#????#??#?#????? 1,1,12,1
?#??.???.?. 2,1
?#.?#.?#??? 1,1,2
?#?#?.???? 3,1
?#??#?????#. 3,1,3,1
???#?##?##??? 1,7
#.?????????????? 1,1,8,1
..??.????.?? 1,1,1
???.???#????.???? 1,6,1,1
?????#???? 1,5
.?#.???#???. 2,1,1,1
???#???.??#?. 6,1,1
.????#???#??.?.??#? 6,1,1,2
?????????? 1,3
.?###?#???. 6,1
?????.#????#????#?? 1,1,2,1,8
??##?#??#?.#?#?. 7,3
???#????#?? 2,1,1
.?.#??#????.??.??.?. 4,1
??.??.????.?? 1,1
???.???#?.??????? 1,3
???.?.??#????. 1,1,3,1
#????????? 3,1,2
.???###.?.???? 3,1
???###??????#..??? 6,2,1,1
???##???????? 9,2
#.???#?.?# 1,2,1
#.?#.?##???#????# 1,1,7,1,1
????????#???#??? 2,6,5
???##.??#?#?#?? 2,7
???????.?.???.# 2,1,1,1,1
??.??#?###?##???#.# 1,14,1
??#?##????? 1,7
???????.?#?????#??#? 3,1,11
.??.???#????.??##??? 7,4
????#??.?? 1,3
????#???.??.???..? 6,1
.?.#..#??.?# 1,1,3,1
.??????.?? 6,1
##????#??.# 7,1
.???#?.??????.#? 4,3,1
?#????.#?.##?? 1,1,1,3
????.??#???? 2,5
#??#??????? 6,1
??????#???.????? 2,6,1,1
????#???????????# 7,1,1,1
?.##?.#???.# 3,2,1
?.????.?.#?? 2,2
???#????#????. 1,2,7
?????.??#????#? 4,3,2
????..??#??.?#??. 4,3,3
#??.??#???#???#????? 1,1,4,9
#????????? 6,1
????????#.?#?? 1,1,2,4
.?#?.#???.???#?#? 1,4,5
??#??#???#?.????? 8,1,1,2
???.??##?#?#???# 1,10
???.?????. 1,1,1
??..?#??????#?#?#??? 1,11
#???#.?#?. 3,1,3
??#?##?#??##??.?.?? 11,1
??.?.??.???#?. 1,1,1,3
.?#??#???.???. 2,1,1,2
?#?..??#?? 2,5
??#???#???#???. 3,8,1
..????????. 3,2
?????##.?#??#? 1,3,2,1
?????.???.?#????? 2,2,1,6
.??#?.???#??????..? 3,5
????????###.?. 4,3
?###???#??????????#. 8,4,5
?#?.#?????????? 2,7,1
???#????#??.?.??? 6,1,1,1,1
??????????.#? 8,2
???#?.??#???. 1,3,1,2
?.??.??#.?#??.?? 2,3,1,1,1
#????.??#.?#?????.? 1,2,3,6,1
#???????#???# 6,1,1
.?#???.?#? 5,1
??????.????????????? 3,4,7
.#.??.?#??#????.??? 1,1,9,3
?.???#?#??. 1,1,4
??#???##?..??#?? 9,2
??.??.?????##?.??. 1,1,1,5,1
??.??#??.#?????#?#?. 1,5,2,5
.?##???##??.?? 3,5
?#??#???.?????.??? 7,1,2,1
????.?#???. 1,5
?#????#????.#??? 10,1,1
#.?####?.?. 1,6,1
?#.??#?.??? 1,3
.??????#?.?##? 2,4,3
??##?????????????? 3,10
.?.???.#?.?#????. 1,1,2,1,2
.????.?##?.????##? 4,3,7
?????????? 1,3
?.#????.#?.??? 1,2,1,1
????.?#.?. 1,1,1
###?.?##?####?????? 4,3,7,1
??.?????#.#???? 1,4,1,1
?.?..#??#??? 1,5
#??#???.?#? 2,2,1
.?.?#?.?..?. 1,1,1,1
#?..?#???##????? 1,7,1
???#?????.#??# 9,1,1
?#????????.??. 6,1,1,1
???#?##???.???#??? 1,7,1,4
#?#?#???????????#? 1,3,2,2,1,1
...#?.???#..#? 1,2,1,2
??#????.??#???#?#?.. 7,3,5
???###.??#??#?? 6,4,1
.??????#.#????.#. 6,1,1,1
??????####????#.?.? 5,4,1,1,1
##??#???#?##??#???? 15,1
?#?.????.???.#.? 3,1,1,1,1
??.??#????#?.?? 1,3,3,1
?#???????.???#?#???# 5,1,8,1
#?.???.??#? 2,1,4
????#??????? 2,2,2
.????.#?#?##??. 1,1,1,1,4
????.????????#?#? 1,2,9
??????#.##??? 2,2,3
.?????#???.??? 2,4,1
.?????#???#???# 3,10
???##????#.??.? 5,1,1,1,1
??#?.#??#???.####?? 1,1,1,4,6
????#????.?.??#?? 6,4
??..?.?.?..# 1,1,1,1
??????????#? 1,1,1,1
??##????#..?.????##. 4,3,1,1,2
.?#?.?.??.#???????# 1,1,1,1,1,4
?.?#..?#?#?#?#? 1,8
.#...??#??##?#???? 1,11
??.#???.???#??##?? 1,5
???????????? 1,1,5
?????????#?????.?. 3,1,2,3,1
?#?????#...? 2,3,1
??.????#??????????.# 1,6,1,1,1,1
?.?#???#?#.?#?.. 3,3,2
?##???..##? 5,2
??.?.??#??? 2,1,5
??#???.???.?#. 2,2,2,1
???#??????????.?? 5,1,1
###?.???#?? 4,4
??.??#?#?????.???? 1,5,1,3
??#??#?.??# 6,1
?.#?#?##?.####.??.# 1,3,3,4,1,1
?#???.????#?#?###? 3,12
????..?????? 1,1,1,1
?.?#?.#?#??##???# 1,2,7,1
????..??????#?. 1,1,3,1,2
??##????.??#?.??. 4,1,1,2,2
.????.????#???? 3,1,3,1
?.?????##?????.??? 10,1
?#??#??#????#???#. 1,5,1,3,1
#?.?.????###?.#???# 1,1,7,1,1,1
.#??#??????#???# 1,2,7
??.###?????? 1,3,3,1
???#?.????#??.?.??? 3,4,2
??????###?#???#??#?. 1,13
#?.#?????#??????? 1,1,1,1,6
#??.???..?? 3,3,1
.???#??#??????.? 1,5,3
#?#??#???##?.???.# 11,2,1
?#???.#?.??#??? 1,1,1,3,1
?#??##?##?.?? 2,5,1
?.##???.???#?? 4,5
?.?##??#???? 1,6,1
?#?###.???#????#?#?# 6,10
##.?..??.?? 2,1,1
??.????????????. 4,1,2
???..#????#??????.? 7,2
#.?#??????##? 1,2,1,3
.??#????#...#?.? 7,1
?.?#????####???.?? 1,1,10,1
?#??#?#???..????? 8,5
???#?.??????# 5,1,2,1
.??.?##??? 1,3,1
??.????????? 1,2
??#.???#?##??#.? 1,1,8
?????.#??#???###?.? 1,1,4,5
#??##?????.#??#?? 7,1,2,1
##?#?.#.??????????? 5,1,2,1,1,3
?##?#.???????.?#.??. 3,1,6,2,1
.??.???????#?#?#?# 1,1,1,5,3
???????????.??. 4,1,2,1
?#.????#????#?.?.? 2,10,1
.?#.?????? 2,1,4
.??#?#.??????..? 5,3
??????#???????..??? 5,2
???????##??#??????. 8,1,3,1
#?#..?#?????#?#?#?#. 3,12,1
?????#???#?..#??? 5,1
???#?#??#??.??##???? 1,2,1,3,8
??#.?.???????.#???.# 3,1,5,1,1
?????????. 1,1,1
??.??????#.#?#?#?#?? 4,1,3,4
?#?#.???????.?.???? 4,1,4,1,1,2
?#?..?##???#.? 1,3,2
??#.#.?#??.?? 1,1,2,1
#?#????..???.?#.? 7,3,2,1
?#.?##??##?? 1,8
??????#?#??... 2,7
?????#?.??#?. 7,1,1
#?.?????#???..?.??? 1,4
?#?#??##??????????? 15,1
??.#?#??#.????????? 1,6,1,1,1
????##??#.?#?? 7,1
?.##.????##??????? 2,7,3
?????.?.##??.? 2,3
??..????#???????? 1,1,3,1,4
?.#????..??????#?. 1,5,5
??#?#????.?#?? 1,3,1,2
?#??????#??#??????? 3,1,5,1,3
?.???.?.#??.????.? 2,1,3,2,1
.?#????.??.#?.#?#?? 3,1,1,2,1,3
???#??#???????? 1,12
??????.#?#???##? 1,5,2
??????##?..??????? 3,4,1,2
?#???#??.???.#?#?? 3,3,1,3
???#????.??.. 2,1,2,1
#??###??##??? 1,7
??.??.?#.???????.?? 1,1,1,4,1,1
??????????#??? 2,1,7
???.??#????#? 1,7
??????????#? 1,2,2,1
?##???##???????#???# 3,3,8,1
?.#????#??????.# 2,3,3,1
?.?#??#..?.?.??? 1,2,1,1,2
???#?????. 4,1
..?#.??????##??# 1,1,5,1
????#?##??.?? 8,2
?#.?.????????#??? 1,1,1,3,6
?.?..#???#???#..??? 9,2
?#?.???.?????.???? 2,5
?###????#?#???#?? 4,5,1,2
???.??.??????...# 1,2,4,1
#???#.????#?#??##? 5,9
??.????.?#??. 2,1,1,1
#.?#???.??????? 1,1,2,1,5
#?#??..?.#??#? 5,1,5
?#?????#???. 5,2
??.????????#?#?. 1,1,1,1,3
#???????#??##?#?#?. 1,9,1,1
????.#?#.#?##?? 1,1,1,1,5
??.?#???????#?? 3,8
???#??.???.? 4,1
?#????????.??? 1,1,1,3
??..???#.?.? 2,3,1
?#???#????#?????. 3,11
?.??.???##.?#? 2,4,1
?????.?#.???????.? 1,2,1,1,2,1
.????.?#.?.?.#????.? 2,3
.#?###??#???. 6,4
??#?#???.? 6,1
?.???##?#?. 1,5
???????????.??##?. 1,6,1,1,3
?.?#?.?.?????#??? 1,2,1,1,3
??????#??##?.#. 2,2,2,1
.??#?#?.#??.??? 4,2,1
.????.?#???.????.??. 3,3
???#.????#???? 3,4,1
?????#????#???..??? 10,1
?#???????#?????? 1,1,4,1,1
?#?##?#?????###? 9,5
?.####?###???#?? 12,1
?#??#?#?..?# 5,2,1
????#??.?##? 1,1,1,2
??????????? 2,1
??.?##.????##?? 1,3,6
.????#?.##???#??. 1,4,3
?.???????#?##??#? 1,10
##??.??#???. 4,5
????##???#??????. 6,2,1,1
???.??#??..??#??.?## 1,3,5,3
????.#?#??.?? 2,5
#???..???.#. 1,2,1,1
???.??#.??.# 1,2,1,1
???#??????. 4,1
?????#???#????#.?. 1,9,2,1
??#??#?????#?.? 8,1
??#??.???#??#?????.# 2,10,1
?????#?##?#??.#?#? 11,1,1
?#???.#??##??##??.? 1,2,5,4,1
??.???#?#??#?.? 1,6,1
?#..???????.?????.#? 2,7,2,2,1
??.???????##? 2,1,1,4
???######??.??. 8,1
?????#????# 1,5,1
#?###?.??. 1,4,2
?????????????.? 1,1,2,1,1
#??.????.?##??? 2,1,3
.???.#????.????#? 2,5,3,2
?????????#?? 2,2,1
??##?.?#?.?? 2,3,1
??####??#??.#?.??? 8,1,1,1";

        internal long Part1()
        {
            return Solve(1);
        }

        internal long Part2()
        {
            return Solve(5);
        }

        private long Solve(int copies)
        {
            long answer = 0;
            foreach (var line in input.Split(Environment.NewLine))
            {
                var sections = line.Split(" ");
                var record = Unfold(sections[0], '?', copies);
                var groups = Unfold(sections[1], ',', copies).Split(',').Select(int.Parse);
                answer += GetArrangements(record, ImmutableStack.CreateRange(groups.Reverse()), new MemoCache());
            }
            return answer;
        }

        string Unfold(string s, char joiningChar, int copies)
        {
            return string.Join(joiningChar, Enumerable.Repeat(s, copies));
        }

        long GetArrangements(string record, ImmutableStack<int> groups, MemoCache cache)
        {
            if (!cache.ContainsKey((record, groups)))
            {
                cache[(record, groups)] = KickOffRecursion(record, groups, cache);
            }
            return cache[(record, groups)];
        }

        long KickOffRecursion(string record, ImmutableStack<int> groups, MemoCache cache)
        {
            switch (record.FirstOrDefault())
            {
                case '.': return Operational(record, groups, cache);
                case '#': return Damaged(record, groups, cache);
                case '?': return Unknown(record, groups, cache);
                default: return EndOfRecord(groups);
            }
        }

        long Operational(string record, ImmutableStack<int> groups, MemoCache cache)
        {
            return GetArrangements(record[1..], groups, cache);
        }

        long Unknown(string record, ImmutableStack<int> groups, MemoCache cache)
        {
            return GetArrangements("." + record[1..], groups, cache) + GetArrangements("#" + record[1..], groups, cache);
        }

        long Damaged(string record, ImmutableStack<int> groups, MemoCache cache)
        {
            if (!groups.Any()) return 0;
            var nextGroupLength = groups.Peek();
            groups = groups.Pop();
            var possiblyDamaged = record.TakeWhile(s => s is '#' or '?').Count();
            if (possiblyDamaged < nextGroupLength) return 0;
            if (record.Length == nextGroupLength) return GetArrangements("", groups, cache);
            if (record[nextGroupLength] == '#') return 0;
            return GetArrangements(record[(nextGroupLength + 1)..], groups, cache);
        }

        long EndOfRecord(ImmutableStack<int> groups)
        {
            return groups.Any() ? 0 : 1;
        }
    }
}
